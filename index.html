<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CO2-Play — Upload Excel → Curva → Melhor R² → Fluxo</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#070b16; --card:#0f1a33; --line:rgba(255,255,255,.10);
      --text:#eaf1ff; --muted:#a7b8de;
      --blue:#3b82f6; --green:#22c55e; --orange:#f97316; --pink:#ec4899; --red:#ef4444;
      --shadow:0 18px 48px rgba(0,0,0,.35); --r:18px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);
      background:radial-gradient(900px 500px at 30% -10%, rgba(59,130,246,.28), transparent 60%),
               radial-gradient(800px 500px at 90% 10%, rgba(236,72,153,.22), transparent 60%),
               radial-gradient(900px 700px at 50% 110%, rgba(34,197,94,.18), transparent 60%),
               linear-gradient(180deg, #050812, var(--bg));
    }
    header{position:sticky;top:0;z-index:2;backdrop-filter:blur(10px);
      background:rgba(7,11,22,.70); border-bottom:1px solid var(--line);}
    .top{max-width:1200px;margin:0 auto;padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .brand h1{margin:0;font-size:16px}
    .brand p{margin:0;font-size:12px;color:var(--muted)}
    main{max-width:1200px;margin:0 auto;padding:14px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(15,26,51,.92); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden;}
    .hd{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,255,255,.04), transparent); border-bottom:1px solid var(--line);}
    .hd h2{margin:0;font-size:14px}
    .bd{padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, select, textarea{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:var(--text);outline:none;}
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:180px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{border:0;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer;color:#071022;
      box-shadow:0 12px 26px rgba(0,0,0,.30); transition:transform .06s ease;}
    button:active{transform:scale(.98)}
    .b-blue{background:linear-gradient(90deg,var(--blue),#60a5fa)}
    .b-green{background:linear-gradient(90deg,var(--green),#86efac)}
    .b-orange{background:linear-gradient(90deg,var(--orange),#fdba74)}
    .b-pink{background:linear-gradient(90deg,var(--pink),#f9a8d4)}
    .b-red{background:linear-gradient(90deg,var(--red),#fca5a5)}
    .ghost{background:transparent;color:var(--text);border:1px solid var(--line);box-shadow:none}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03); font-size:12px; color:var(--muted)}
    .status{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px dashed var(--line);
      background:rgba(255,255,255,.03);font-size:12px;color:var(--muted);white-space:pre-wrap}
    canvas{width:100%;height:360px;background:rgba(7,11,22,.35);border:1px solid var(--line);border-radius:16px;}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kpi{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:14px;padding:10px}
    .kpi .v{font-size:16px;font-weight:950}
    .kpi .k{font-size:11px;color:var(--muted);margin-top:2px}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);
      border-radius:14px;background:rgba(11,20,43,.7);overflow:hidden}
    th,td{font-size:12px;padding:9px 10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{color:#cfe0ff;background:rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <h1>CO2-Play — Curva, Melhor R² e Fluxo</h1>
      <p>Agora as colunas são escolhidas por A/B/C… (não quebra com cabeçalho duplicado).</p>
    </div>
    <div class="pill" id="fileInfo">sem arquivo</div>
  </div>
</header>

<main>
  <div class="grid">

    <section class="card">
      <div class="hd">
        <h2>1) Upload e Curva</h2>
        <span class="pill" id="ptsInfo">0 pontos</span>
      </div>
      <div class="bd">
        <label>Arquivo Excel (.xlsx/.xls)</label>
        <input id="file" type="file" accept=".xlsx,.xls"/>

        <div class="row">
          <div class="col">
            <label>Aba</label>
            <select id="sheet"></select>
          </div>
          <div class="col">
            <label>Linha do cabeçalho</label>
            <input id="headerRow" type="number" value="1" min="1"/>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Tempo (segundos)</label>
            <select id="colT"></select>
            <div class="pill" id="hintT">dica: normalmente C — time2</div>
          </div>
          <div class="col">
            <label>CO₂ (ppm)</label>
            <select id="colC"></select>
            <div class="pill" id="hintC">dica: normalmente F — CO2(ppm)</div>
          </div>
        </div>

        <div class="btns">
          <button class="ghost" id="btnGuess">Auto-detectar</button>
          <button class="b-blue" id="btnLoad">Carregar curva</button>
          <button class="ghost" id="btnDiag">Diagnóstico</button>
        </div>

        <div class="status" id="status">Suba o arquivo → Auto-detectar → Carregar curva.</div>

        <div style="margin-top:12px"><canvas id="chart"></canvas></div>

        <div style="margin-top:10px;max-height:220px;overflow:auto">
          <table>
            <thead><tr><th>t (s)</th><th>CO₂ (ppm)</th></tr></thead>
            <tbody id="preview"></tbody>
          </table>
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="hd">
        <h2>2) Melhor R² e Fluxo</h2>
        <span class="pill" id="fitInfo">sem ajuste</span>
      </div>
      <div class="bd">
        <div class="row">
          <div class="col"><label>Janela mínima (s)</label><input id="wmin" type="number" value="60" min="5"/></div>
          <div class="col"><label>Passo (s)</label><input id="step" type="number" value="5" min="1"/></div>
        </div>

        <div class="btns">
          <button class="b-green" id="btnAutoFit">Melhor reta (R² máximo)</button>
          <button class="ghost" id="btnResetFit">Limpar ajuste</button>
        </div>

        <div class="row">
          <div class="col"><label>Manual t_ini (s)</label><input id="t0" type="number" step="1"/></div>
          <div class="col"><label>Manual t_fim (s)</label><input id="tf" type="number" step="1"/></div>
        </div>

        <div class="btns">
          <button class="b-blue" id="btnManualFit">Calcular (manual)</button>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="v" id="k_r2">—</div><div class="k">R²</div></div>
          <div class="kpi"><div class="v" id="k_slope">—</div><div class="k">Slope (ppm/s)</div></div>
          <div class="kpi"><div class="v" id="k_win">—</div><div class="k">Janela (s)</div></div>
          <div class="kpi"><div class="v" id="k_flux">—</div><div class="k">Fluxo (mg m⁻² h⁻¹)</div></div>
        </div>

        <label>Variáveis do Fluxo (editáveis)</label>
        <div class="row">
          <div class="col"><label>V (m³)</label><input id="V" type="number" value="0.010" step="0.0001"/></div>
          <div class="col"><label>A (m²)</label><input id="A" type="number" value="0.070" step="0.0001"/></div>
        </div>
        <div class="row">
          <div class="col"><label>P (Pa)</label><input id="P" type="number" value="101325"/></div>
          <div class="col"><label>T (°C)</label><input id="T" type="number" value="25" step="0.1"/></div>
        </div>

        <div class="btns">
          <button class="b-orange" id="btnRecalcFlux">Recalcular fluxo</button>
        </div>

        <div class="status" id="status2">Se não aparecer pontos, escolha explicitamente: <b>C — time2</b> e <b>F — CO2(ppm)</b>.</div>
      </div>
    </aside>

  </div>
</main>

<script>
let wb=null, cols=[], colIdToIdx=new Map(), series=[], chart=null, currentFit=null;
const $=id=>document.getElementById(id);
const setStatus=m=>$("status").textContent=m;
const pill=(id,m)=>$(id).textContent=m;

function toNum(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : NaN;
}
function colLetter(i){
  let n=i+1, s="";
  while(n>0){ const r=(n-1)%26; s=String.fromCharCode(65+r)+s; n=Math.floor((n-1)/26); }
  return s;
}
function esc(s){
  return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

$("file").addEventListener("change", async (ev)=>{
  const f=ev.target.files?.[0];
  if(!f) return;
  const buf=await f.arrayBuffer();
  wb=XLSX.read(buf,{type:"array"});
  $("sheet").innerHTML = wb.SheetNames.map(n=>`<option>${esc(n)}</option>`).join("");
  pill("fileInfo", f.name);
  setStatus("Arquivo carregado. Clique Auto-detectar.");
});

$("btnGuess").addEventListener("click", ()=>{
  if(!wb) return setStatus("Suba um Excel primeiro.");
  buildColumns();
  autoPickColumns();
  setStatus("Auto-detect feito. Clique Carregar curva.");
});

$("btnLoad").addEventListener("click", ()=>{
  if(!wb) return setStatus("Suba um Excel primeiro.");
  if(!cols.length) buildColumns();
  loadCurve();
});

$("btnDiag").addEventListener("click", ()=>{
  if(!wb) return setStatus("Suba um Excel primeiro.");
  if(!cols.length) buildColumns();
  const msg = [
    `Aba: ${$("sheet").value}`,
    `Header row: ${$("headerRow").value}`,
    `Tempo selecionado: ${$("colT").value}`,
    `CO2 selecionado: ${$("colC").value}`,
    `Pontos carregados: ${series.length}`
  ].join("\n");
  setStatus(msg);
});

function buildColumns(){
  const sheet=$("sheet").value;
  const hrow=Math.max(1, Number($("headerRow").value||1));
  const ws=wb.Sheets[sheet];
  const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:""});
  const header=(rows[hrow-1]||[]).map(h=>String(h??"").trim());

  cols = header.map((name,i)=>({
    idx:i,
    id:`c${i}`,
    name: name || `(col ${colLetter(i)})`
  }));
  colIdToIdx = new Map(cols.map(c=>[c.id,c.idx]));

  const opts = cols.map(c=>`<option value="${esc(c.id)}">${esc(colLetter(c.idx))} — ${esc(c.name)}</option>`).join("");
  $("colT").innerHTML = opts;
  $("colC").innerHTML = opts;
}

function scoreNumeric(colIdx){
  const sheet=$("sheet").value;
  const hrow=Math.max(1, Number($("headerRow").value||1));
  const ws=wb.Sheets[sheet];
  const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:""});
  const data = rows.slice(hrow, hrow+120);
  let ok=0, tot=0;
  for(const r of data){
    const v=r[colIdx];
    if(v===null||v===undefined||v==="") continue;
    tot++;
    if(Number.isFinite(Number(v))) ok++;
  }
  return tot? ok/tot : 0;
}

function autoPickColumns(){
  // Heurística forte pro seu Excel:
  // Tempo: preferir colunas cujo nome pareça time2/seconds e sejam majoritariamente numéricas.
  // CO2: preferir nome CO2(ppm) e numérica.
  let bestT=null, bestC=null;

  for(const c of cols){
    const nm=c.name.toLowerCase();
    const sc=scoreNumeric(c.idx);

    // tempo
    const tBonus = (/(time2|seconds|tempo_s|sec)/.test(nm) ? 2 : /(time|tempo)/.test(nm) ? 1 : 0);
    const tScore = sc + tBonus;
    if(!bestT || tScore>bestT.tScore) bestT={id:c.id, tScore, sc, nm};

    // co2
    const cBonus = (/^co2\(ppm\)$/.test(nm) ? 2 : /co2/.test(nm) ? 1 : 0);
    const cScore = sc + cBonus;
    if(!bestC || cScore>bestC.cScore) bestC={id:c.id, cScore, sc, nm};
  }

  if(bestT) $("colT").value = bestT.id;
  if(bestC) $("colC").value = bestC.id;

  // dicas visuais
  $("hintT").textContent = `auto: ${labelOf(bestT?.id)} (num=${(bestT?.sc||0).toFixed(2)})`;
  $("hintC").textContent = `auto: ${labelOf(bestC?.id)} (num=${(bestC?.sc||0).toFixed(2)})`;
}

function labelOf(colId){
  const idx = colIdToIdx.get(colId);
  const c = cols.find(x=>x.id===colId);
  if(idx===undefined || !c) return "(?)";
  return `${colLetter(idx)} — ${c.name}`;
}

function loadCurve(){
  const sheet=$("sheet").value;
  const hrow=Math.max(1, Number($("headerRow").value||1));
  const ws=wb.Sheets[sheet];
  const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:""});
  const tIdx = colIdToIdx.get($("colT").value);
  const cIdx = colIdToIdx.get($("colC").value);

  if(tIdx===undefined || cIdx===undefined){
    setStatus("Selecione Tempo e CO2.");
    return;
  }

  series=[];
  for(const r of rows.slice(hrow)){
    const t=toNum(r[tIdx]);
    const c=toNum(r[cIdx]);
    if(!Number.isFinite(t) || !Number.isFinite(c)) continue;
    series.push({t,c});
  }
  series.sort((a,b)=>a.t-b.t);

  pill("ptsInfo", `${series.length} pontos`);
  renderPreview();

  if(series.length<3){
    setStatus(
      "Não achei pontos numéricos suficientes.\n" +
      "Na sua planilha, escolha explicitamente:\n" +
      "Tempo = C — time2\nCO2 = F — CO2(ppm)\n" +
      "e clique Carregar curva novamente."
    );
    drawChart(null);
    resetFit();
    return;
  }

  setStatus(`Curva OK ✅ Tempo=${labelOf($("colT").value)} | CO2=${labelOf($("colC").value)}.\nAgora clique “Melhor reta (R² máximo)”.`);
  drawChart(null);
  resetFit();
}

function renderPreview(){
  const tb=$("preview");
  tb.innerHTML="";
  const show = series.slice(0,8).concat(series.length>12 ? [{t:"…",c:"…"}] : []).concat(series.slice(-4));
  for(const p of show){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${esc(p.t)}</td><td>${esc(p.c)}</td>`;
    tb.appendChild(tr);
  }
}

function drawChart(fit){
  const ctx=$("chart").getContext("2d");
  const ds=[{
    label:"CO₂ (ppm)",
    data: series.map(p=>({x:p.t,y:p.c})),
    pointRadius:3, showLine:false
  }];
  if(fit && Number.isFinite(fit.slope)){
    const t0=fit.t_ini, tf=fit.t_fim;
    ds.push({
      label:`Reta (R²=${fit.r2.toFixed(4)})`,
      data:[{x:t0,y:fit.slope*t0+fit.intercept},{x:tf,y:fit.slope*tf+fit.intercept}],
      pointRadius:0, showLine:true, borderWidth:3
    });
  }
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"scatter",
    data:{datasets:ds},
    options:{
      responsive:true, maintainAspectRatio:false, parsing:false,
      scales:{ x:{title:{display:true,text:"Tempo (s)"}}, y:{title:{display:true,text:"CO₂ (ppm)"}} },
      plugins:{ legend:{labels:{color:"#eaf1ff"}} }
    }
  });
}

/* ===== regressão ===== */
function linearRegression(sub){
  const n=sub.length;
  const x=sub.map(p=>p.t), y=sub.map(p=>p.c);
  const mx=x.reduce((a,b)=>a+b,0)/n, my=y.reduce((a,b)=>a+b,0)/n;
  let num=0, den=0;
  for(let i=0;i<n;i++){ num+=(x[i]-mx)*(y[i]-my); den+=(x[i]-mx)*(x[i]-mx); }
  const slope=den===0?NaN:num/den;
  const intercept=my-slope*mx;
  let ssTot=0, ssRes=0;
  for(let i=0;i<n;i++){
    const yhat=slope*x[i]+intercept;
    ssTot+=(y[i]-my)**2;
    ssRes+=(y[i]-yhat)**2;
  }
  const r2=ssTot===0?NaN:1-ssRes/ssTot;
  return {slope,intercept,r2,n};
}

$("btnAutoFit").addEventListener("click", ()=>{
  if(series.length<5) return setStatus("Poucos pontos para ajuste.");
  const wmin=Math.max(3, Number($("wmin").value||60));
  const step=Math.max(1, Number($("step").value||5));
  const tMin=series[0].t, tMax=series[series.length-1].t;

  let best=null;
  for(let t0=tMin;t0<=tMax;t0+=step){
    for(let tf=t0+wmin;tf<=tMax;tf+=step){
      const sub=series.filter(p=>p.t>=t0 && p.t<=tf);
      if(sub.length<3) continue;
      const reg=linearRegression(sub);
      if(!Number.isFinite(reg.r2)) continue;
      if(!best || reg.r2>best.r2) best={...reg,t_ini:t0,t_fim:tf,metodo:"auto_R2max"};
    }
  }
  if(!best) return setStatus("Não achei janela válida. Tente diminuir janela mínima.");
  applyFit(best);
  setStatus(`Auto-fit OK ✅ R²=${best.r2.toFixed(4)} janela=[${best.t_ini},${best.t_fim}] n=${best.n}`);
});

$("btnManualFit").addEventListener("click", ()=>{
  const t0=toNum($("t0").value), tf=toNum($("tf").value);
  if(!Number.isFinite(t0)||!Number.isFinite(tf)||tf<=t0) return setStatus("Intervalo manual inválido.");
  const sub=series.filter(p=>p.t>=t0&&p.t<=tf);
  if(sub.length<3) return setStatus("Menos de 3 pontos na janela.");
  const reg=linearRegression(sub);
  if(!Number.isFinite(reg.r2)) return setStatus("R² não calculável.");
  applyFit({...reg,t_ini:t0,t_fim:tf,metodo:"manual"});
  setStatus(`Manual OK ✅ R²=${reg.r2.toFixed(4)} n=${reg.n}`);
});

$("btnResetFit").addEventListener("click", resetFit);
$("btnRecalcFlux").addEventListener("click", recalcFlux);

function resetFit(){
  currentFit=null;
  pill("fitInfo","sem ajuste");
  $("k_r2").textContent="—";
  $("k_slope").textContent="—";
  $("k_win").textContent="—";
  $("k_flux").textContent="—";
  $("t0").value=""; $("tf").value="";
  drawChart(null);
}

function applyFit(fit){
  currentFit=fit;
  pill("fitInfo", `${fit.metodo} R²=${fit.r2.toFixed(4)}`);
  $("k_r2").textContent=fit.r2.toFixed(4);
  $("k_slope").textContent=fit.slope.toFixed(6);
  $("k_win").textContent=`${fit.t_ini} – ${fit.t_fim}`;
  $("t0").value=fit.t_ini; $("tf").value=fit.t_fim;
  drawChart(fit);
  recalcFlux();
}

function recalcFlux(){
  if(!currentFit || !Number.isFinite(currentFit.slope)) return;
  const slope=currentFit.slope;
  const V=toNum($("V").value), A=toNum($("A").value), P=toNum($("P").value), T=toNum($("T").value);
  if(![V,A,P,T].every(Number.isFinite) || V<=0 || A<=0 || P<=0) return;

  const R=8.314462618;
  const MCO2=44.0095;
  const TK=T+273.15;

  const flux = (slope*1e-6) * (P/(R*TK)) * (V/A) * (MCO2*1000) * 3600;
  $("k_flux").textContent = Number.isFinite(flux)? flux.toFixed(3) : "—";
}
</script>
</body>
</html>
